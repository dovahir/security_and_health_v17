<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="view_security_situation_tree" model="ir.ui.view">
        <field name="name">Security Situation Tree</field>
        <field name="model">security.situation</field>
        <field name="arch" type="xml">
            <tree string="Situación de Seguridad" expand="1">
                <field name="name" readonly="1"
                       decoration-bf="1"
                />
                <field name="type"/>
                <field name="event_date" context="{'time_format': 'HH:mm'}"/>
                <field name="employee_id"
                       widget="many2one_avatar_user"/>
                <field name="follow"/>
                <field name="work_center_id"/>
                <field name="work_area_id"/>
                <field name="event_severity"/>
                <field name="state" widget="badge"
                       decoration-info="state == 'active'"
                       decoration-success="state == 'concluded'"/>
            </tree>
        </field>
    </record>

    <record id="view_security_situation_form" model="ir.ui.view">
        <field name="name">Security Situation Form</field>
        <field name="model">security.situation</field>
        <field name="arch" type="xml">
            <form string="Situación de Seguridad">
                <header>
                    <button name="action_conclude" string="Marcar Concluido" type="object"
                            class="oe_highlight" invisible="state != 'active'"/>
                    <button name="action_draft" string="Volver a Borrador" type="object"
                            invisible="state != 'concluded'"/>
                    <field name="state" widget="statusbar" statusbar_visible="active,concluded"/>
                </header>

                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button type="object"
                                name="action_open_final_report"
                                class="oe_stat_button"
                                icon="fa-file-text-o"
                                invisible="state != 'concluded'">
                            <span class="o_stat_text">Reporte Final</span>
                        </button>
                    </div>
                    <div class="oe_title ">
                        <h1 class="d-flex flex-row">
                            <field name="name"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="create_date" string="Fecha de creación" readonly="1"/>
                            <field name="event_date"
                                string="Fecha del evento"
                                required="1"
                                widget="datetime"
                                context="{'time_format': 'HH:mm'}"
                                readonly="state == 'concluded'"/>
                            <field name="type" required="1" readonly="state == 'concluded'"/>
                            <field name="cause" required="1" readonly="state == 'concluded'"/>
                            <field name="employee_id"
                                   options="{'no_create': True}"
                                   readonly="state == 'concluded'"
                                   required="type == 'accident'"
                            />
                            <field name="job_id"/>
                            <field name="department_id"/>
                            <field name="parent_id"/>
                            <field name="follow" readonly="state == 'concluded'"/>
                            <field name="company_id" readonly="state == 'concluded'"/>
                            <field name="work_center_id"
                                   required="1"
                                   options="{'no_create': True}"
                                   readonly="state == 'concluded'"
                                   domain="[('company_id', '=', company_id)]"/>
                        </group>
                        <group>
                            <field name="work_area_id"
                                   string="Área / Lugar exacto"
                                   readonly="state == 'concluded'"
                                   options=" {'no_create': True}"
                                   domain="[('location_id', '=', work_center_id)]"/>
                            <field name="event_severity" required="1" readonly="state == 'concluded'"/>
                            <field name="injury_type_id" readonly="state == 'concluded'"/>
                            <field name="injury_severity" readonly="state == 'concluded'"/>
                            <field name="witnesses" widget="many2many_tags" readonly="state == 'concluded'" options="{'no_open': False, 'no_create': True}"/>
                            <field name="activities_type_id" readonly="state == 'concluded'"/>
                            <field name="factor_type"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Detalles y Evidencias">
                            <group string="Descripción del Suceso">
                                <field name="details_whats" required="1" readonly="state == 'concluded'"/>
                                <field name="details_how" required="1" readonly="state == 'concluded'"/>
                                <field name="details_when" required="1" readonly="state == 'concluded'"/>
                            </group>
                            <group string="Evidencias Fotográficas" name="group_evidence">
                                <table>
                                    <tr>
                                        <td style="padding: 50px; text-align: center;">
                                            <field name="evidence_photo_1" widget="image" style="max-width: 200px;" readonly="state == 'concluded'"/>
                                            <br/>
                                            <span>Evidencia 1</span>
                                        </td>
                                        <td style="padding: 50px; text-align: center;">
                                            <field name="evidence_photo_2" widget="image" style="max-width: 200px;" readonly="state == 'concluded'"/>
                                            <br/>
                                            <span>Evidencia 2</span>
                                        </td>
                                        <td style="padding: 50px; text-align: center;">
                                            <field name="evidence_photo_3" widget="image" style="max-width: 200px;" readonly="state == 'concluded'"/>
                                            <br/>
                                            <span>Evidencia 3</span>
                                        </td>
                                    </tr>
                                </table>
                            </group>
                        </page>

                        <page string="Seguimiento / Atenciones">
                            <field name="attention_ids" nolabel="1"
                                context="{'default_situation_id': id}">
                                <tree editable="bottom" string="Atenciones">
                                    <field name="date_time" readonly="parent.state == 'concluded'"/>
                                    <field name="attention_type" readonly="parent.state == 'concluded'"/>
                                    <field name="responsible_id" readonly="parent.state == 'concluded'"/>
                                    <field name="action_taken" string="Detalle" readonly="parent.state == 'concluded'"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>

                <div class="oe_chatter">
                   <field name="message_follower_ids" groups="base.group_user"/>
                   <field name="message_ids" widget="mail_thread"/>
                </div>

            </form>
        </field>
    </record>

    <!-- Filtros -->
    <record id="view_security_situation_search" model="ir.ui.view">
        <field name="name">Security Situation Search</field>
        <field name="model">security.situation</field>
        <field name="arch" type="xml">
            <search string="Buscar situaciones">
                <field name="type"/>
                <field name="factor_type"/>
                <field name="event_severity"/>
                <field name="work_center_id"/>
                <field name="employee_id"/>
                <field name="department_id"/>
                <field name="job_id"/>
                <field name="parent_id"/>

                <filter name="only_accidents" string="Accidentes"
                        domain="[('type','=','accident')]"/>
                <filter name="only_incidents" string="Incidentes"
                        domain="[('type', '=', 'incident')]"/>
                <filter name="only_quasi_accidents" string="Cuasi Accidentes"
                        domain="[('type','=','quasi_accident')]"/>
                <filter name="only_lost_time_injury" string="Incidente con Pérdida de Tiempo"
                        domain="[('type','=','lost_time_injury')]"/>
                <filter name="only_medical_treatment" string="Requiere tratamiento médico"
                        domain="[('type', '=', 'medical_treatment')]"/>
                <filter name="only_first_aid" string="Primeros Auxilios"
                        domain="[('type','=','first_aid')]"/>
                <filter name="only_restricted_work_case" string="Caso de Trabajo Restringido"
                        domain="[('type','=','restricted_work_case')]"/>
                <filter name="only_non_work_related" string="No Relacionado con Act. Laborales"
                        domain="[('type', '=', 'non_work_related')]"/>
                <filter name="only_near_misses_incident" string="Incidente Near Misses"
                        domain="[('type','=','near_misses_incident')]"/>

                <separator/>
                <filter name="event_date" string="Fecha del Evento" date="event_date"/>
                <separator/>

                <group expand="1" string="Agrupar por">
                    <filter name="group_by_type" string="Tipo"
                            context="{'group_by': 'type'}"/>
                    <filter name="group_by_factor_type" string="Factor Tipo"
                            context="{'group_by': 'factor_type'}"/>
                    <filter name="group_by_severity" string="Severidad"
                            context="{'group_by': 'event_severity'}"/>
                    <filter name="group_by_work_center" string="Ubicaciones de Trabajo"
                            context="{'group_by': 'work_center_id'}"/>
                    <filter name="group_by_employee" string="Empleado"
                            context="{'group_by': 'employee_id'}"/>
                    <filter name="group_by_department" string="Departamento"
                            context="{'group_by': 'department_id'}"/>
                    <filter name="group_by_job" string="Puesto de trabajo"
                            context="{'group_by': 'job_id'}"/>
                    <filter name="group_by_parent" string="Líder directo"
                            context="{'group_by': 'parent_id'}"/>
                    <filter name="group_by_event_date" string="Fecha"
                            context="{'group_by': 'event_date'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="view_security_situation_pivot" model="ir.ui.view">
        <field name="name">Security Situation Pivot</field>
        <field name="model">security.situation</field>
        <field name="arch" type="xml">
            <pivot string="Análisis de Situaciones de Seguridad">
                <field name="type" type="row"/>
                <field name="event_date" interval="month" type="col"/>
            </pivot>
        </field>
    </record>

    <record id="view_security_situation_graph" model="ir.ui.view">
        <field name="name">Security Situation Graph</field>
        <field name="model">security.situation</field>
        <field name="arch" type="xml">
            <graph string="Análisis de Situaciones de Seguridad" type="bar">
                <field name="type" type="row"/>
                <field name="event_date" interval="month"/>
                <field name="id" operator="count" string="Total Registros" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Acción -->
    <record id="action_security_situation" model="ir.actions.act_window">
        <field name="name">Situaciones</field>
        <field name="res_model">security.situation</field>
        <field name="view_mode">tree,form</field>
    </record>

    <record id="action_security_situation_analysis" model="ir.actions.act_window">
        <field name="name">Estadísticas de Seguridad</field>
        <field name="res_model">security.situation</field>
        <field name="view_mode">graph,pivot,tree</field>
        <field name="context">{'search_default_group_by_type': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crea tu primer análisis de situaciones de seguridad.
            </p>
        </field>
    </record>

</odoo>